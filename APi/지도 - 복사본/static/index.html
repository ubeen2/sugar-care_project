<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <title>ë‚´ ì£¼ë³€ ê±´ê°• ì¥ì†Œ íƒìƒ‰ (í‰ì  í†µí•©)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body{font-family:system-ui,'Noto Sans KR',sans-serif;margin:0;background:#f7f7f7;}
    header{padding:12px 16px;background:#222;color:#fff;font-weight:600}
    .wrap{display:flex;gap:16px;padding:16px}
    #map{height:78vh;flex:2;min-width:520px;border-radius:12px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.08)}
    .side{flex:1;min-width:320px;max-width:420px;height:78vh;overflow:auto}
    .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    .btn{cursor:pointer;padding:8px 12px;border:none;border-radius:8px;background:#4f46e5;color:#fff}
    .btn.secondary{background:#0ea5e9}
    .sel,.input{padding:7px 8px;border:1px solid #ddd;border-radius:8px;background:#fff}
    .row{display:flex;gap:8px;margin-bottom:8px}
    .cards .card{border:1px solid #e5e5e5;border-radius:12px;background:#fff;margin-bottom:10px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,.06)}
    .cards .card img{width:100%;height:160px;object-fit:cover;display:block}
    .cards .cnt{padding:10px}
    .pill{display:inline-block;font-size:12px;background:#eef;padding:2px 8px;border-radius:999px;margin-right:6px}
    .muted{color:#666;font-size:12px}
  </style>
</head>
<body>
<header>ë‚´ ì£¼ë³€ ê±´ê°• ì¥ì†Œ íƒìƒ‰ (í‰ì  í†µí•©)</header>
<div class="wrap">
  <div id="map"></div>

  <div class="side">
    <div class="toolbar">
      <button id="btnLocate" class="btn secondary">ğŸ“ ë‚´ ìœ„ì¹˜</button>
      <select id="selCat" class="sel">
        <option value="ì „ì²´">ì „ì²´</option>
        <option value="í—¬ìŠ¤ì¥">í—¬ìŠ¤ì¥</option>
        <option value="ê³µì›">ê³µì›</option>
        <option value="ë‚´ê³¼">ë‚´ê³¼</option>
        <option value="ì¢…í•©ë³‘ì›">ì¢…í•©ë³‘ì›</option>
        <option value="ë‚´ë¶„ë¹„ë‚´ê³¼">ë‚´ë¶„ë¹„ë‚´ê³¼</option>
      </select>
      <select id="selSort" class="sel">
        <option value="accuracy">ì •í™•ë„ìˆœ</option>
        <option value="distance">ê°€ê¹Œìš´ìˆœ</option>
        <option value="rating">í‰ì ìˆœ</option>
      </select>
      <input id="inRadius" class="input" type="number" min="1" max="20" value="3" style="width:72px"> km
      <button id="btnSearch" class="btn">ê²€ìƒ‰</button>
    </div>

    <div class="row">
      <input id="inCoord" class="input" style="flex:1" placeholder="(ìœ„ë„,ê²½ë„) ë˜ëŠ” ì£¼ì†Œ ì…ë ¥"/>
      <button id="btnAddr" class="btn">ì£¼ì†Œë¡œ ê²€ìƒ‰</button>
    </div>

    <div class="cards">
      <div id="cards"></div>
    </div>
  </div>
</div>

<script>
const map = L.map('map').setView([37.5665, 126.9780], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let meMarker=null, placeLayer=L.layerGroup().addTo(map);

// ì•„ì´ì½˜ ì•ˆì „ ë¡œë“œ
// const ICONS = {
//
//   "í—¬ìŠ¤ì¥": "https://raw.githubusercontent.com/seonghuyn/icon_list/master/weightlifter.png",
//   "ê³µì›": "https://github.com/seonghuyn/icon_list/blob/master/park%20(1).png?raw=true",
//   "ë‚´ê³¼": "https://raw.githubusercontent.com/seonghuyn/icon_list/master/stethoscope1.png",
//   "ì¢…í•©ë³‘ì›": "https://raw.githubusercontent.com/seonghuyn/icon_list/master/hospital.png",
//   "ë‚´ë¶„ë¹„ë‚´ê³¼": "https://img.icons8.com/ios/50/pills.png"
// };
const ICONS = {
  "í—¬ìŠ¤ì¥": "https://img.icons8.com/?size=100&id=1uTCzCEvN6rL&format=png&color=000000",
  "ê³µì›": "https://cdn-icons-png.flaticon.com/512/861/861060.png",
  "ë‚´ê³¼": "https://cdn-icons-png.flaticon.com/512/2966/2966489.png",
  "ì¢…í•©ë³‘ì›": "https://cdn-icons-png.flaticon.com/512/616/616554.png",
  "ë‚´ë¶„ë¹„ë‚´ê³¼": "https://cdn-icons-png.flaticon.com/512/2920/2920678.png"
};
const defaultIcon = L.icon({
  iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
  iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
  shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
  iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]
});
function loadIcon(url){return new Promise(res=>{if(!url){res(null);return;}const img=new Image();img.onload=()=>res(L.icon({iconUrl:url,iconSize:[32,32],iconAnchor:[16,32]}));img.onerror=()=>res(null);img.src=url;});}
async function safeMarker(lat, lon, cat){const url=ICONS[cat];const icon=await loadIcon(url);return L.marker([lat,lon], icon?{icon}:{icon:defaultIcon});}

function setMeMarker(lat, lon){
  if(meMarker) map.removeLayer(meMarker);
  meMarker = L.marker([lat,lon], {icon:defaultIcon}).addTo(map).bindPopup("<b>ë‚´ ìœ„ì¹˜</b>").openPopup();
  map.setView([lat,lon], 14);
}

function renderCards(places){
  const dfImg = places.filter(p=>p["ëŒ€í‘œì´ë¯¸ì§€"]);
  const top5 = dfImg.slice(0,5);
  const cards = document.getElementById('cards'); cards.innerHTML="";
  if(top5.length===0){ cards.innerHTML='<div class="muted">í‘œì‹œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  for(const p of top5){
    const rating = (typeof p["í‰ì "]==='number')? p["í‰ì "].toFixed(1) : 'ì •ë³´ ì—†ìŒ';
    cards.innerHTML += `
      <div class="card">
        <img src="${p["ëŒ€í‘œì´ë¯¸ì§€"]}" alt="">
        <div class="cnt">
          <span class="pill">${p["ì¹´í…Œê³ ë¦¬"]}</span>
          <div style="font-weight:600;margin-top:4px">${p["ì´ë¦„"]}</div>
          <div class="muted" style="margin-top:2px">â­ ${rating}</div>
          <div class="muted" style="margin-top:4px">${p["ì£¼ì†Œ"]||""}</div>
          <div style="margin-top:6px"><a href="${p["ë§í¬"]}" target="_blank" rel="noopener">ì¹´ì¹´ì˜¤ë§µì—ì„œ ë³´ê¸°</a></div>
        </div>
      </div>`;
  }
}

async function geocode(q){
  const res = await fetch(`/api/geocode?q=${encodeURIComponent(q)}`);
  const data = await res.json();
  if(!data.ok) throw new Error(data.error||'geocode failed');
  return {lat:data.lat, lon:data.lon};
}
async function searchAround(lat, lon){
  const category = document.getElementById('selCat').value;
  const sort = document.getElementById('selSort').value;
  const radius_km = parseInt(document.getElementById('inRadius').value||'3',10);
  const url = `/api/search?lat=${lat}&lon=${lon}&category=${encodeURIComponent(category)}&sort=${sort}&radius_km=${radius_km}`;
  const res = await fetch(url);
  const data = await res.json();
  if(!data.ok){ alert('ê²€ìƒ‰ ì‹¤íŒ¨'); return; }

  placeLayer.clearLayers();
  renderCards(data.places);

  for(const p of data.places){
    const rating=(typeof p["í‰ì "]==='number')?p["í‰ì "].toFixed(1):'ì •ë³´ ì—†ìŒ';
    const imgHtml = p["ëŒ€í‘œì´ë¯¸ì§€"]?`<img src="${p["ëŒ€í‘œì´ë¯¸ì§€"]}" style="width:150px;height:100px;object-fit:cover;border-radius:6px;"><br>`:'';
    const html = `
      <b>${p["ì´ë¦„"]}</b><br>
      ì¹´í…Œê³ ë¦¬: ${p["ì¹´í…Œê³ ë¦¬"]}<br>
      ì£¼ì†Œ: ${p["ì£¼ì†Œ"]||"-"}<br>
      ì „í™”: ${p["ì „í™”ë²ˆí˜¸"]||"-"}<br>
      â­ í‰ì : ${rating}<br>
      ${imgHtml}
      <a href="${p["ë§í¬"]}" target="_blank" rel="noopener">ì¹´ì¹´ì˜¤ë§µì—ì„œ ë³´ê¸°</a>`;
    const mk = await safeMarker(p["ìœ„ë„"], p["ê²½ë„"], p["ì¹´í…Œê³ ë¦¬"]);
    mk.addTo(placeLayer).bindPopup(html);
  }
}

document.getElementById('btnLocate').addEventListener('click', ()=>getMyLocation(true));
document.getElementById('btnSearch').addEventListener('click', async ()=>{
  const v=document.getElementById('inCoord').value.trim();
  if(!v){ alert('ì¢Œí‘œ ë˜ëŠ” ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  let lat, lon;
  if(v.startsWith("(") && v.includes(",")){
    try{ const [a,b]=v.replace(/[()]/g,'').split(','); lat=parseFloat(a); lon=parseFloat(b);}catch(e){}
  }else{
    try{ const p=await geocode(v); lat=p.lat; lon=p.lon;}catch(e){ alert('ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨'); return; }
  }
  setMeMarker(lat, lon); searchAround(lat, lon);
});
document.getElementById('btnAddr').addEventListener('click', async ()=>{
  const v=document.getElementById('inCoord').value.trim();
  if(!v){ alert('ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  try{ const p=await geocode(v); setMeMarker(p.lat,p.lon); searchAround(p.lat,p.lon);}catch(e){ alert('ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨: '+e.message);}
});

function getMyLocation(focus){
  if(!navigator.geolocation){ alert("ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=+pos.coords.latitude.toFixed(6), lon=+pos.coords.longitude.toFixed(6);
    document.getElementById('inCoord').value=`(${lat},${lon})`;
    if(focus) setMeMarker(lat,lon);
    searchAround(lat,lon);
  }, err=>alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: "+err.message));
}
window.addEventListener('load', ()=>getMyLocation(true));
</script>
</body>
</html>
